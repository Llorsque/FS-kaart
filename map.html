<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Schoolschaatsen ‚Äì Kaart</title>
  <link rel="stylesheet" href="styles.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
</head>
<body>
  <div class="container">
    <aside class="sidebar">
      <header>
        <h1>üó∫Ô∏è Kaart</h1>
        <p class="sub">Upload Excel, kies filters, bekijk markers en aantallen.</p>
      </header>
      <section class="card controls">
        <div class="row">
          <input type="file" id="fileInput" accept=".xlsx,.xls" />
          <button id="clearCacheBtn" type="button">Cache legen</button>
          <button id="downloadBtn" type="button" disabled>Download CSV (met Lat/Lon)</button>
        </div>
        <div class="row">
          <div style="width:100%">
            <div id="progressText" class="muted">Nog geen bestand ge√ºpload.</div>
            <div class="progress"><div id="progressBar" class="progressbar"></div></div>
          </div>
        </div>
        <div class="row"><strong>Filters</strong></div>
        <div id="dynamicFilters" class="row" style="gap:12px;flex-direction:column"></div>
        <div class="row">
          <button id="applyFiltersBtn" type="button">Filters toepassen</button>
          <button id="resetFiltersBtn" type="button">Reset</button>
        </div>
      </section>
      <section class="card">
        <h3 style="margin-top:0">Live aantallen</h3>
        <div class="kpis">
          <div class="kpi"><div class="label">Totaal (gefilterd)</div><div id="k_total" class="n">‚Äì</div></div>
          <div class="kpi"><div class="label">Geocodeerd</div><div id="k_geo" class="n">‚Äì</div></div>
        </div>
        <div style="margin-top:8px">
          <div class="legend" id="yearPills"></div>
        </div>
      </section>
      <section class="card table">
        <table id="previewTable">
          <thead></thead>
          <tbody></tbody>
        </table>
      </section>
    </aside>
    <main class="main">
      <div id="map"></div>
    </main>
  </div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="utils.js"></script>
  <script>
  const progressText = document.getElementById('progressText');
  const progressBar = document.getElementById('progressBar');
  updateProgress = (c,t,p)=>{
    const pct = t? Math.round((c/t)*100):0;
    progressText.textContent = t? `${p}: ${c}/${t} (${pct}%)` : 'Gereed.';
    progressBar.style.width = pct + '%';
  };

  const map = L.map('map').setView([52.2,5.3],7);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {maxZoom:19}).addTo(map);
  const markerGroup = L.layerGroup().addTo(map);
  let allRows = []; let filtered = []; let yearKeys = []; let filterPredicate = ()=>true;

  const fileInput = document.getElementById('fileInput');
  const clearCacheBtn = document.getElementById('clearCacheBtn');
  const downloadBtn = document.getElementById('downloadBtn');
  const applyFiltersBtn = document.getElementById('applyFiltersBtn');
  const resetFiltersBtn = document.getElementById('resetFiltersBtn');
  const k_total = document.getElementById('k_total');
  const k_geo = document.getElementById('k_geo');
  const yearPills = document.getElementById('yearPills');
  const tblHead = document.querySelector('#previewTable thead');
  const tblBody = document.querySelector('#previewTable tbody');

  function renderTable(rows){
    tblHead.innerHTML=''; tblBody.innerHTML='';
    if(!rows.length) return;
    const cols = Object.keys(rows[0]);
    const tr = document.createElement('tr');
    cols.forEach(c=>{ const th=document.createElement('th'); th.textContent=c; tr.appendChild(th); });
    tblHead.appendChild(tr);
    rows.slice(0,50).forEach(r=>{
      const tr = document.createElement('tr');
      cols.forEach(c=>{ const td=document.createElement('td'); td.textContent = r[c] ?? ''; tr.appendChild(td); });
      tblBody.appendChild(tr);
    });
  }

  function applyFilters(){
    filtered = allRows.filter(filterPredicate);
    renderMap(filtered);
    renderKPIs(filtered);
    renderTable(filtered);
  }
  function resetFilters(){
    document.getElementById('dynamicFilters').querySelectorAll('select').forEach(s=>s.value='');
    applyFilters();
  }

  function renderKPIs(rows){
    k_total.textContent = rows.length;
    const geoN = rows.filter(r=>r.lat&&r.lon).length;
    k_geo.textContent = geoN;
    yearPills.innerHTML='';
    const counts = computeYearCounts(rows, yearKeys);
    Object.entries(counts).forEach(([y,n])=>{
      const div = document.createElement('div'); div.className='pill'; div.textContent = `${y}: ${n}`; yearPills.appendChild(div);
    });
  }

  function renderMap(rows){
    markerGroup.clearLayers();
    const markers = [];
    for(const r of rows){
      if(!(r.lat && r.lon)) continue;
      const m = L.marker([r.lat, r.lon]).addTo(markerGroup);
      const naam = r.Naam || r.naam || r.School || r.school || '';
      const adres = r.Adres || r.adres || '';
      const pc = r.Postcode || r.postcode || '';
      const plaats = r.Plaats || r.plaats || r.Gemeente || r.gemeente || '';
      m.bindPopup(`<strong>${naam}</strong><br>${adres}<br>${pc} ${plaats}`);
      markers.push(m);
    }
    if(markers.length){
      const grp = L.featureGroup(markers);
      map.fitBounds(grp.getBounds().pad(0.12));
    }
  }

  async function handleFile(file){
    progressText.textContent = 'Bestand lezen...'; progressBar.style.width='0%';
    const data = await file.arrayBuffer();
    const wb = XLSX.read(data,{type:'array'});
    const ws = wb.Sheets[wb.SheetNames[0]];
    const rows = XLSX.utils.sheet_to_json(ws, {defval:''});
    if(!rows.length){ progressText.textContent='Leeg bestand.'; return; }

    yearKeys = [];
    for(const key of Object.keys(rows[0])){
      if(isYearHeader(key)) yearKeys.push(toSeasonKey(key));
    }
    const normalized = rows.map(r=>{
      const out = {...r};
      for(const y of yearKeys){
        const raw = r[y]!=null ? r[y] : r[String(y).replace('/','-')] ;
        const b = parseBoolCell(raw);
        out[y] = (b===true);
      }
      return out;
    });

    const addrBuilder = (r)=>{
      const adres = r.Adres||r.adres||'';
      const pc = r.Postcode||r.postcode||'';
      const plaats = r.Plaats||r.plaats||r.Gemeente||r.gemeente||'';
      return `${adres}, ${pc} ${plaats}, Nederland`;
    };
    const withGeo = await geocodeRows(normalized, addrBuilder);
    allRows = withGeo;

    filterPredicate = buildDynamicFilters(allRows, yearKeys);
    applyFilters();

    progressText.textContent = `Gereed. Geocodeerd: ${allRows.filter(r=>r.lat&&r.lon).length}/${allRows.length}`;
    progressBar.style.width='100%';
    downloadBtn.disabled = false;
  }

  fileInput.addEventListener('change', e=>{const f=e.target.files?.[0]; if(f) handleFile(f);});
  clearCacheBtn.addEventListener('click', ()=>{ localStorage.removeItem('geo_cache_schools_v1'); alert('Geocoding-cache geleegd.'); });
  applyFiltersBtn.addEventListener('click', applyFilters);
  resetFiltersBtn.addEventListener('click', resetFilters);
  downloadBtn.addEventListener('click', ()=>{
    const headers = Object.keys(allRows[0]||{});
    const lines = [headers.join(',')];
    for(const r of allRows){
      const vals = headers.map(h=>{
        const s = String(r[h]??'');
        return /[",\n]/.test(s) ? '"' + s.replace(/"/g,'""') + '"' : s;
      });
      lines.push(vals.join(','));
    }
    const blob = new Blob([lines.join('\n')],{type:'text/csv;charset=utf-8;'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href=url; a.download='geocoded_export.csv'; a.click(); URL.revokeObjectURL(url);
  });
  </script>
</body>
</html>
