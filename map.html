<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Schoolschaatsen ‚Äì Kaart (v3)</title>
  <link rel="stylesheet" href="styles.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
</head>
<body>
  <div class="container">
    <aside class="sidebar">
      <header>
        <h1>üó∫Ô∏è Kaart</h1>
        <p class="sub">Upload Excel ‚Üí geocoding (Nominatim of PDOK) ‚Üí filters (incl. seizoenen & ranges) ‚Üí markers + aantallen.</p>
      </header>
      <section class="card controls">
        <div class="row">
          <input type="file" id="fileInput" accept=".xlsx,.xls" />
          <button id="clearCacheBtn" type="button">Cache legen</button>
        </div>
        <div class="row">
          <label>Geocoder:
            <select id="geocoderSel">
              <option value="pdok">PDOK (NL, sneller)</option>
              <option value="nominatim">Nominatim (OSM)</option>
            </select>
          </label>
          <label>Throttle (ms):
            <input type="number" id="throttleMs" value="250" min="0" step="50"/>
          </label>
          <button id="downloadCsvBtn" type="button" disabled>Download CSV</button>
          <button id="downloadXlsxBtn" type="button" disabled>Download Excel (XLSX)</button>
        </div>
        <div class="row">
          <div style="width:100%">
            <div id="progressText" class="muted">Nog geen bestand ge√ºpload.</div>
            <div class="progress"><div id="progressBar" class="progressbar"></div></div>
          </div>
        </div>
        <div class="row"><strong>Filters</strong></div>
        <div id="dynamicFilters" class="filters-block"></div>
        <div class="row">
          <button id="applyFiltersBtn" type="button">Filters toepassen</button>
          <button id="resetFiltersBtn" type="button">Reset</button>
        </div>
      </section>
      <section class="card">
        <h3 style="margin-top:0">Live aantallen</h3>
        <div class="kpis">
          <div class="kpi"><div class="label">Totaal (gefilterd)</div><div id="k_total" class="n">‚Äì</div></div>
          <div class="kpi"><div class="label">Geocodeerd</div><div id="k_geo" class="n">‚Äì</div></div>
        </div>
        <div style="margin-top:8px">
          <div class="legend" id="yearPills"></div>
        </div>
      </section>
      <section class="card table">
        <table id="previewTable">
          <thead></thead>
          <tbody></tbody>
        </table>
      </section>
    </aside>
    <main class="main">
      <div id="map"></div>
    </main>
  </div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="utils.js"></script>
  <script>
  const progressText = document.getElementById('progressText');
  const progressBar = document.getElementById('progressBar');
  updateProgress = (c,t,p)=>{
    const pct = t? Math.round((c/t)*100):0;
    progressText.textContent = t? `${p}: ${c}/${t} (${pct}%)` : 'Gereed.';
    progressBar.style.width = pct + '%';
  };

  const map = L.map('map').setView([52.2,5.3],7);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {maxZoom:19}).addTo(map);
  const markerGroup = L.layerGroup().addTo(map);
  let allRows = []; let filtered = []; let yearSeasons=[]; let filterPredicate = ()=>true;

  const fileInput = document.getElementById('fileInput');
  const clearCacheBtn = document.getElementById('clearCacheBtn');
  const geocoderSel = document.getElementById('geocoderSel');
  const throttleMs = document.getElementById('throttleMs');
  const downloadCsvBtn = document.getElementById('downloadCsvBtn');
  const downloadXlsxBtn = document.getElementById('downloadXlsxBtn');
  const applyFiltersBtn = document.getElementById('applyFiltersBtn');
  const resetFiltersBtn = document.getElementById('resetFiltersBtn');
  const k_total = document.getElementById('k_total');
  const k_geo = document.getElementById('k_geo');
  const yearPills = document.getElementById('yearPills');
  const tblHead = document.querySelector('#previewTable thead');
  const tblBody = document.querySelector('#previewTable tbody');

  function renderTable(rows){
    tblHead.innerHTML=''; tblBody.innerHTML='';
    if(!rows.length) return;
    const cols = Object.keys(rows[0]);
    const tr = document.createElement('tr');
    cols.forEach(c=>{ const th=document.createElement('th'); th.textContent=c; tr.appendChild(th); });
    tblHead.appendChild(tr);
    rows.slice(0,50).forEach(r=>{
      const tr = document.createElement('tr');
      cols.forEach(c=>{ const td=document.createElement('td'); td.textContent = r[c] ?? ''; tr.appendChild(td); });
      tblBody.appendChild(tr);
    });
  }

  function applyFilters(){
    filtered = allRows.filter(filterPredicate);
    renderMap(filtered);
    renderKPIs(filtered);
    renderTable(filtered);
  }
  function resetFilters(){
    document.getElementById('dynamicFilters').querySelectorAll('select, input[type=checkbox], input[type=number]').forEach(el=>{
      if(el.type==='checkbox') el.checked=false; else el.value='';
    });
    applyFilters();
  }

  function renderKPIs(rows){
    k_total.textContent = rows.length;
    const geoN = rows.filter(r=>r.lat&&r.lon).length;
    k_geo.textContent = geoN;
    yearPills.innerHTML='';
    for(const s of yearSeasons){
      const n = rows.reduce((acc,r)=> acc + (r['_season__'+s]===true?1:0), 0);
      const div = document.createElement('div'); div.className='pill'; div.textContent = `${s}: ${n}`;
      yearPills.appendChild(div);
    }
  }

  function renderMap(rows){
    markerGroup.clearLayers();
    const markers = [];
    for(const r of rows){
      if(!(r.lat && r.lon)) continue;
      const m = L.marker([r.lat, r.lon]).addTo(markerGroup);
      const naam = r['NAAM SCHOOL'] || r.Naam || r.naam || r.School || r.school || '';
      const adres = r.ADRES || r.Adres || r.adres || '';
      const pc = r.POSTCODE || r.Postcode || r.postcode || '';
      const plaats = r.PLAATSNAAM || r.Plaats || r.plaats || r.GEMEENTENAAM || r.gemeente || '';
      m.bindPopup(`<strong>${naam}</strong><br>${adres}<br>${pc} ${plaats}`);
      markers.push(m);
    }
    if(markers.length){
      const grp = L.featureGroup(markers);
      map.fitBounds(grp.getBounds().pad(0.12));
    }
  }

  // === Geocoders ===
  async function geocodeNominatim(query){
    const params = new URLSearchParams({format:'jsonv2',q:query,addressdetails:'0',limit:'1',countrycodes:'nl','accept-language':'nl'});
    const url = `https://nominatim.openstreetmap.org/search?${params.toString()}`;
    const res = await fetch(url,{headers:{'Accept':'application/json'}});
    if(!res.ok) throw new Error('Nominatim error '+res.status);
    const json = await res.json();
    if(Array.isArray(json)&&json.length){ return {lat:parseFloat(json[0].lat), lon:parseFloat(json[0].lon)}; }
    return {lat:null, lon:null};
  }
  async function geocodePDOK(query){
    // PDOK Locatieserver v3: free endpoint, JSON
    const params = new URLSearchParams({q:query, wt:'json'});
    const url = `https://geodata.nationaalgeoregister.nl/locatieserver/v3/free?${params.toString()}`;
    const res = await fetch(url,{headers:{'Accept':'application/json'}});
    if(!res.ok) throw new Error('PDOK error '+res.status);
    const json = await res.json();
    const doc = json && json.response && json.response.docs && json.response.docs[0];
    if(doc && doc.centroide_ll){
      // centroide_ll: "POINT(lon lat)"
      const m = doc.centroide_ll.match(/POINT\(([-\d\.]+)\s+([\-\d\.]+)\)/);
      if(m){ return {lat:parseFloat(m[2]), lon:parseFloat(m[1])}; }
    }
    return {lat:null, lon:null};
  }

  async function geocodeRows(rows){
    const total = rows.length; let done=0; updateProgress(0,total,'Geocoding');
    const out = [];
    const cache = JSON.parse(localStorage.getItem('geo_cache_schools_v1')||'{}');
    const usePDOK = geocoderSel.value==='pdok';
    const wait = parseInt(throttleMs.value||'250',10);

    for(const r of rows){
      const adres = r.ADRES||r.Adres||r.adres||'';
      const pc = r.POSTCODE||r.Postcode||r.postcode||'';
      const plaats = r.PLAATSNAAM||r.Plaats||r.plaats||r.GEMEENTENAAM||r.gemeente||'';
      const query = `${adres}, ${pc} ${plaats}, Nederland`;
      if(cache[query]){
        out.push({...r, lat:cache[query].lat, lon:cache[query].lon});
      }else{
        try{
          const c = usePDOK ? await geocodePDOK(query) : await geocodeNominatim(query);
          cache[query]=c; out.push({...r, lat:c.lat, lon:c.lon});
        }catch(e){
          console.error('Geocode fout', query, e);
          out.push({...r, lat:null, lon:null});
        }
        if(wait>0){ await new Promise(res=>setTimeout(res, wait)); }
      }
      done++; updateProgress(done,total,'Geocoding');
    }
    localStorage.setItem('geo_cache_schools_v1', JSON.stringify(cache));
    return out;
  }

  function toCSV(rows){
    const headers = Object.keys(rows[0]||{});
    const lines = [headers.join(',')];
    for(const r of rows){
      const vals = headers.map(h=>{
        const s = String(r[h]??'');
        return /[",\n]/.test(s) ? '"' + s.replace(/"/g,'""') + '"' : s;
      });
      lines.push(vals.join(','));
    }
    return lines.join('\n');
  }

  async function handleFile(file){
    progressText.textContent = 'Bestand lezen...'; progressBar.style.width='0%';
    const data = await file.arrayBuffer();
    const wb = XLSX.read(data,{type:'array'});
    const ws = wb.Sheets[wb.SheetNames[0]];
    const rows = XLSX.utils.sheet_to_json(ws, {defval:''});
    if(!rows.length){ progressText.textContent='Leeg bestand.'; return; }

    const derived = deriveSeasonsAndFlags(rows);
    yearSeasons = derived.yearSeasons;
    let enriched = derived.rows;

    const withGeo = await geocodeRows(enriched);
    allRows = withGeo;

    const excluded = new Set(['NAAM SCHOOL','Naam','naam','ADRES','Adres','adres','POSTCODE','Postcode','postcode','PROVINCIE','Provincie','provincie','HUISNUMMER-TOEVOEGING','PLAATSNAAM CORRESPONDENTIEADRES']);
    filterPredicate = buildDynamicFilters(allRows, yearSeasons, {excludedColumns: excluded});
    applyFilters();

    progressText.textContent = `Gereed. Geocodeerd: ${allRows.filter(r=>r.lat&&r.lon).length}/${allRows.length}`;
    progressBar.style.width='100%';
    downloadCsvBtn.disabled = false;
    downloadXlsxBtn.disabled = false;
  }

  fileInput.addEventListener('change', e=>{const f=e.target.files?.[0]; if(f) handleFile(f);});
  clearCacheBtn.addEventListener('click', ()=>{ localStorage.removeItem('geo_cache_schools_v1'); alert('Geocoding-cache geleegd.'); });
  applyFiltersBtn.addEventListener('click', applyFilters);
  resetFiltersBtn.addEventListener('click', resetFilters);

  downloadCsvBtn.addEventListener('click', ()=>{
    const csv = toCSV(allRows);
    const blob = new Blob([csv],{type:'text/csv;charset=utf-8;'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href=url; a.download='geocoded_export.csv'; a.click(); URL.revokeObjectURL(url);
  });
  downloadXlsxBtn.addEventListener('click', ()=> exportXLSX(allRows, 'geocoded_export.xlsx'));
  </script>
</body>
</html>
